from fastapi import FastAPI, HTTPException, Request, Depends
from fastapi.responses import JSONResponse
from pydantic import BaseModel
from sqlalchemy.orm import Session
from dotenv import load_dotenv
import requests
from config import (
    REFERRAL_AMOUNT,
    YOOKASSA_SECRET_KEY,
    MAHIN_URL,
    YOO_KASSA_SHOP_ID
)
import os
import aiohttp
import uvicorn
from database import get_db, create_payout, get_user, mark_payout_as_notified, create_referral

load_dotenv()

# FastAPI application
app = FastAPI()

class UserRegisterRequest(BaseModel):
    telegram_id: str
    username: str
    referrer_id: str

class PaymentRequest(BaseModel):
    amount: float
    description: str
    telegram_id: str

@app.post("/pay")
async def pay(request: PaymentRequest, db: Session = Depends(get_db)):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞."""
    user = get_user(db, request.telegram_id)
    if not user:
        raise HTTPException(status_code=400, detail="User not found")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ YooKassa
    try:
        payment_response = await create_payment(request.amount, request.description, request.telegram_id)
        return payment_response
    except HTTPException as e:
        raise HTTPException(status_code=e.status_code, detail=e.detail)


async def create_payment(amount: float, description: str, telegram_id: str):
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ YooKassa."""
    url = "https://api.yookassa.ru/v3/payments"
    headers = {
        "Authorization": f"Bearer {YOOKASSA_SECRET_KEY}",
        "Content-Type": "application/json",
    }
    payment_data = {
        "amount": {
            "value": f"{amount:.2f}",  # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É–º–º—É —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            "currency": "RUB"
        },
        "confirmation": {
            "type": "redirect",
            "return_url": "https://web.telegram.org/a/#7859098027"
        },
        "capture": True,
        "description": description,
        "metadata": {
            "telegram_id": telegram_id  # –î–æ–±–∞–≤–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        }
    }
    async with aiohttp.ClientSession() as session:
        async with session.post(url, headers=headers, json=payment_data) as response:
            if response.status == 200:
                payment_response = await response.json()
                confirmation_url = payment_response.get('confirmation', {}).get('confirmation_url')
                if confirmation_url:
                    return {
                        'confirmation': {
                            'confirmation_url': confirmation_url  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                        }
                    }
                else:
                    raise HTTPException(status_code=400, detail="No confirmation URL found")
            else:
                raise HTTPException(status_code=response.status, detail=f"Failed to create payment: {await response.text()}")

@app.post("/payment_notification")
async def payment_notification(request: Request, db: Session = Depends(get_db)):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ –æ—Ç YooKassa."""
    data = await request.json()
    payment_id = data.get("id")
    status = data.get("status")
    user_telegram_id = data.get("metadata", {}).get("telegram_id")

    if status == "succeeded" and user_telegram_id:
        user = get_user(db, user_telegram_id)
        if user:
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user.payment_status = "paid"
            db.commit()

            # –í—ã–ø–ª–∞—Ç–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—É, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if user.referrer_id:
                referrer = get_user(db, user.referrer_id)
                if referrer:
                    create_payout(db, referrer.id, REFERRAL_AMOUNT)  # –í—ã–ø–ª–∞—Ç–∞ –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞

            # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ Referral
            create_referral(db, user.referrer_id, user.id)

            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–ª–∞—Ç—ã
            mark_payout_as_notified(db, payment_id)

            # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ mahin.py –¥–ª—è –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            notify_url = f"{MAHIN_URL}/notify_user"
            notification_data = {
                "telegram_id": user_telegram_id,
                "message": "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à –ø–ª–∞—Ç—ë–∂ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ, –≤—ã –æ–ø–ª–∞—Ç–∏–ª–∏ –∫—É—Ä—Å! üéâ"
            }
            response = requests.post(notify_url, json=notification_data)

            if response.status_code == 200:
                return {"message": "Payment processed and user notified successfully"}
            else:
                raise HTTPException(status_code=500, detail="Failed to notify user through bot")

    raise HTTPException(status_code=400, detail="Payment not processed")

# Database session dependency
@app.middleware("http")
async def db_session_middleware(request: Request, call_next):
    request.state.db = get_db()
    response = await call_next(request)
    return response

@app.api_route("/", methods=["GET", "HEAD"])
async def payment_notification(request: Request):
    return JSONResponse(content={"message": "–°—É–ø–µ—Ä"}, status_code=200, headers={"Content-Type": "application/json; charset=utf-8"})

async def run_fastapi():
    port = int(os.getenv("PORT", 8000))  # –ü–æ—Ä—Ç –±—É–¥–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ 8000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    uvicorn.run(app, host="0.0.0.0", port=port)